<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø§Ù„Øª ØªØ³Øª Û² - Ø¨Ø±Ø±Ø³ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ùˆ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }

        .balance-ok {
            background: #dcfce7;
            border-color: #22c55e;
        }

        .balance-error {
            background: #fee2e2;
            border-color: #ef4444;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen p-6">
    <!-- Header -->
    <div class="max-w-6xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">ğŸ§ª Ø­Ø§Ù„Øª ØªØ³Øª Û² - Ø¨Ø±Ø±Ø³ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ Ùˆ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h1>
                    <p class="text-sm text-gray-500 mt-1">Ù…Ù†Ø¨Ø¹: Ø§Ø¹ØªØ¨Ø§Ø±Ø§Øª Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ + ØªÙ…Ù„Ú© Ø¯Ø§Ø±Ø§ÛŒÛŒ Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒØ§ÛŒ</p>
                </div>
                <a href="/portal" class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200">â† Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡
                    Ù¾ÙˆØ±ØªØ§Ù„</a>
            </div>
        </div>

        <!-- Search & Filters -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="font-bold text-gray-800 mb-4">ğŸ” Ø¬Ø³ØªØ¬Ùˆ Ùˆ ÙÛŒÙ„ØªØ±</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ú©Ø¯ ÛŒØ§ Ø´Ø±Ø­ Ø¨ÙˆØ¯Ø¬Ù‡</label>
                    <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ..."
                        class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ù…ØªÙˆÙ„ÛŒ</label>
                    <select id="trusteeFilter" class="w-full p-3 border rounded-xl bg-white">
                        <option value="">Ù‡Ù…Ù‡</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ù…ÙˆØ¶ÙˆØ¹</label>
                    <select id="subjectFilter" class="w-full p-3 border rounded-xl bg-white">
                        <option value="">Ù‡Ù…Ù‡</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ù†ÙˆØ¹ Ø±Ø¯ÛŒÙ</label>
                    <select id="rowTypeFilter" class="w-full p-3 border rounded-xl bg-white">
                        <option value="">Ù‡Ù…Ù‡</option>
                        <option value="Ù…Ø³ØªÙ…Ø±">Ù…Ø³ØªÙ…Ø±</option>
                        <option value="ØºÛŒØ± Ù…Ø³ØªÙ…Ø±">ØºÛŒØ± Ù…Ø³ØªÙ…Ø±</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex gap-3">
                <button onclick="searchBudgets()"
                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">Ø¬Ø³ØªØ¬Ùˆ</button>
                <button onclick="clearFilters()"
                    class="bg-gray-100 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-200">Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†</button>
            </div>
        </div>

        <!-- Results Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Budget Items List -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="font-bold text-gray-800 mb-4">ğŸ“‹ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ <span id="budgetCount"
                        class="text-sm text-gray-500">(0)</span></h2>
                <div id="budgetList" class="space-y-2 max-h-96 overflow-y-auto">
                    <div class="text-gray-400 text-center py-8">Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯...</div>
                </div>
            </div>

            <!-- Budget Details & Events -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="font-bold text-gray-800 mb-4">ğŸ“Š Ø¬Ø²Ø¦ÛŒØ§Øª Ùˆ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§</h2>
                <div id="budgetDetails" class="mb-4">
                    <div class="text-gray-400 text-center py-8">Ø¢ÛŒØªÙ…ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</div>
                </div>
                <div id="eventsList" class="space-y-2 max-h-48 overflow-y-auto hidden"></div>
            </div>

            <!-- Requests & Balance -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h2 class="font-bold text-gray-800 mb-4">ğŸ’° Ú©Ø¯Ù‡Ø§ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ùˆ Ù…ÙˆØ§Ø²Ù†Ù‡</h2>
                <div id="requestsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="text-gray-400 text-center py-8">Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</div>
                </div>
                <div id="balanceSummary" class="mt-4 p-4 rounded-xl border-2 hidden">
                    <!-- Balance summary will be shown here -->
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div id="transactionsSection" class="bg-white rounded-2xl shadow-lg p-6 mt-6 hidden">
            <h2 class="font-bold text-gray-800 mb-4">ğŸ“ Ø¬Ø²Ø¦ÛŒØ§Øª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ <span class="text-sm text-gray-500">(Ø±ÙˆÛŒ Ù‡Ø±
                    Ø±Ø¯ÛŒÙ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯)</span></h2>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-3 text-right">#</th>
                            <th class="p-3 text-right">Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯</th>
                            <th class="p-3 text-right">Ø³Ø±ÙØµÙ„ Ø¬Ø²Ø¡</th>
                            <th class="p-3 text-right">Ø±Ø¯ÛŒÙ Ø¬Ø²Ø¡</th>
                            <th class="p-3 text-right">Ú©Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª</th>
                            <th class="p-3 text-left">Ø¨Ø¯Ù‡Ú©Ø§Ø±</th>
                            <th class="p-3 text-left">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Transaction Detail Box -->
        <div id="transactionDetailBox"
            class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl shadow-lg p-6 mt-6 hidden border-2 border-blue-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-bold text-gray-800">ğŸ” Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„ Ø³Ù†Ø¯</h2>
                <button onclick="closeTransactionDetail()" class="text-gray-500 hover:text-red-500 text-xl">âœ•</button>
            </div>
            <div id="transactionDetailContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Detail content will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        let currentBudgetCode = null;
        let currentEventType = null;

        // Format number with commas
        function formatNumber(num) {
            if (num == null || isNaN(num)) return '0';
            return Math.round(num).toLocaleString('fa-IR');
        }

        // Load filter options
        async function loadFilters() {
            try {
                const res = await fetch('/portal/test2/filters');
                const data = await res.json();

                const trusteeSelect = document.getElementById('trusteeFilter');
                data.trustees.forEach(t => {
                    if (t) trusteeSelect.innerHTML += `<option value="${t}">${t}</option>`;
                });

                const subjectSelect = document.getElementById('subjectFilter');
                data.subjects.forEach(s => {
                    if (s) subjectSelect.innerHTML += `<option value="${s}">${s}</option>`;
                });
            } catch (e) {
                console.error('Error loading filters:', e);
            }
        }

        // Search budget items
        async function searchBudgets() {
            const search = document.getElementById('searchInput').value;
            const trustee = document.getElementById('trusteeFilter').value;
            const subject = document.getElementById('subjectFilter').value;
            const rowType = document.getElementById('rowTypeFilter').value;

            const params = new URLSearchParams();
            if (search) params.append('search', search);
            if (trustee) params.append('trustee', trustee);
            if (subject) params.append('subject', subject);
            if (rowType) params.append('row_type', rowType);

            const container = document.getElementById('budgetList');
            container.innerHTML = '<div class="text-gray-400 text-center py-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

            try {
                const res = await fetch('/portal/test2/budget-items?' + params.toString());
                const data = await res.json();

                document.getElementById('budgetCount').textContent = `(${data.count})`;

                if (data.items.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-center py-8">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                    return;
                }

                let html = '';
                data.items.forEach(item => {
                    const typeColor = item.budget_type === 'hazine' ? 'bg-orange-100 text-orange-700' : 'bg-purple-100 text-purple-700';
                    const typeText = item.budget_type === 'hazine' ? 'Ù‡Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ' : 'Ø³Ø±Ù…Ø§ÛŒÙ‡â€ŒØ§ÛŒ';
                    html += `
                        <div class="p-3 border rounded-lg hover:border-blue-500 cursor-pointer budget-item" 
                             onclick="selectBudget('${item.budget_code}')">
                            <div class="flex justify-between items-start">
                                <div class="font-mono text-blue-600 font-bold">${item.budget_code}</div>
                                <span class="text-xs px-2 py-1 rounded ${typeColor}">${typeText}</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1 line-clamp-2">${item.description || '-'}</div>
                            <div class="text-xs text-gray-400 mt-1">${item.trustee || '-'} | ${item.row_type || '-'}</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="text-red-500 text-center py-4">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';
            }
        }

        // Select a budget item
        async function selectBudget(budgetCode) {
            currentBudgetCode = budgetCode;
            currentEventType = null;

            // Highlight selected
            document.querySelectorAll('.budget-item').forEach(el => {
                el.classList.toggle('border-blue-500', el.onclick.toString().includes(budgetCode));
                el.classList.toggle('bg-blue-50', el.onclick.toString().includes(budgetCode));
            });

            const detailsContainer = document.getElementById('budgetDetails');
            const eventsContainer = document.getElementById('eventsList');

            detailsContainer.innerHTML = '<div class="text-gray-400 text-center py-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

            try {
                const res = await fetch('/portal/test2/budget-items/' + encodeURIComponent(budgetCode));
                const data = await res.json();

                if (data.error) {
                    detailsContainer.innerHTML = `<div class="text-red-500">${data.error}</div>`;
                    return;
                }

                const item = data.budget_item;
                const summary = data.transaction_summary;

                detailsContainer.innerHTML = `
                    <div class="bg-gray-50 p-4 rounded-xl">
                        <div class="font-mono text-lg text-blue-600 font-bold mb-2">${item.budget_code}</div>
                        <div class="text-sm text-gray-700 mb-3">${item.description || '-'}</div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div><span class="text-gray-500">Ù…ØªÙˆÙ„ÛŒ:</span> ${item.trustee || '-'}</div>
                            <div><span class="text-gray-500">Ù…ÙˆØ¶ÙˆØ¹:</span> ${item.subject || '-'}</div>
                            <div><span class="text-gray-500">Ù†ÙˆØ¹:</span> ${item.row_type || '-'}</div>
                            <div><span class="text-gray-500">Ù…Ù†Ø·Ù‚Ù‡:</span> ${item.zone || '-'}</div>
                        </div>
                        ${summary.has_transactions ? `
                            <div class="mt-3 pt-3 border-t">
                                <div class="text-sm font-bold text-gray-700 mb-2">ğŸ“Š Ø®Ù„Ø§ØµÙ‡ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§:</div>
                                <div class="grid grid-cols-2 gap-2 text-xs">
                                    <div>ØªØ¹Ø¯Ø§Ø¯: <span class="font-bold">${summary.count}</span></div>
                                    <div>Ù…ÙˆØ§Ø²Ù†Ù‡: <span class="${summary.balance < 1 ? 'text-green-600' : 'text-red-600'}">${formatNumber(summary.balance)}</span></div>
                                    <div>Ø¨Ø¯Ù‡Ú©Ø§Ø±: ${formatNumber(summary.total_debit)}</div>
                                    <div>Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±: ${formatNumber(summary.total_credit)}</div>
                                </div>
                            </div>
                        ` : '<div class="mt-3 text-yellow-600 text-sm">ØªØ±Ø§Ú©Ù†Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>'}
                    </div>
                `;

                // Load events
                if (summary.has_transactions) {
                    await loadEvents(budgetCode);
                } else {
                    eventsContainer.classList.add('hidden');
                }
            } catch (e) {
                detailsContainer.innerHTML = '<div class="text-red-500">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';
            }

            // Clear requests
            document.getElementById('requestsList').innerHTML = '<div class="text-gray-400 text-center py-8">Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯...</div>';
            document.getElementById('balanceSummary').classList.add('hidden');
            document.getElementById('transactionsSection').classList.add('hidden');
        }

        // Load events for budget
        async function loadEvents(budgetCode) {
            const container = document.getElementById('eventsList');
            container.classList.remove('hidden');
            container.innerHTML = '<div class="text-gray-400 text-center py-2">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

            try {
                const res = await fetch('/portal/test2/events/' + encodeURIComponent(budgetCode));
                const data = await res.json();

                if (data.events.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-center py-2">Ø±ÙˆÛŒØ¯Ø§Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                    return;
                }

                let html = '<div class="text-sm font-bold text-gray-700 mb-2">Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ:</div>';
                data.events.forEach(evt => {
                    html += `
                        <div class="p-2 bg-gray-50 rounded border hover:border-blue-500 cursor-pointer event-item text-sm"
                             onclick="selectEvent('${budgetCode}', '${evt.event_type.replace(/'/g, "\\'")}')">
                            <div class="font-bold text-gray-700">${evt.event_type}</div>
                            <div class="text-xs text-gray-500">${evt.transaction_count} ØªØ±Ø§Ú©Ù†Ø´</div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="text-red-500 text-center py-2">Ø®Ø·Ø§</div>';
            }
        }

        // Select an event
        async function selectEvent(budgetCode, eventType) {
            currentEventType = eventType;

            // Highlight selected event
            document.querySelectorAll('.event-item').forEach(el => {
                const isSelected = el.onclick.toString().includes(eventType);
                el.classList.toggle('border-blue-500', isSelected);
                el.classList.toggle('bg-blue-50', isSelected);
            });

            const container = document.getElementById('requestsList');
            container.innerHTML = '<div class="text-gray-400 text-center py-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

            try {
                const res = await fetch('/portal/test2/requests/' + encodeURIComponent(budgetCode) + '/' + encodeURIComponent(eventType));
                const data = await res.json();

                if (data.requests.length === 0) {
                    container.innerHTML = '<div class="text-gray-400 text-center py-8">Ú©Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
                    return;
                }

                let html = '';
                data.requests.forEach(req => {
                    const balanceClass = req.is_balanced ? 'text-green-600' : 'text-red-600';
                    const balanceIcon = req.is_balanced ? 'âœ“' : 'âœ—';
                    html += `
                        <div class="p-3 border rounded-lg hover:border-blue-500 cursor-pointer request-item"
                             onclick="selectRequest('${budgetCode}', '${eventType.replace(/'/g, "\\'")}', '${req.request_id}')">
                            <div class="flex justify-between items-center">
                                <span class="font-mono font-bold">Ú©Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª: ${req.request_id}</span>
                                <span class="${balanceClass} font-bold">${balanceIcon}</span>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">${req.transaction_count} ØªØ±Ø§Ú©Ù†Ø´</div>
                            <div class="grid grid-cols-2 gap-1 text-xs mt-1">
                                <div>Ø¨Ø¯Ù‡Ú©Ø§Ø±: ${formatNumber(req.total_debit)}</div>
                                <div>Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±: ${formatNumber(req.total_credit)}</div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } catch (e) {
                container.innerHTML = '<div class="text-red-500 text-center py-4">Ø®Ø·Ø§</div>';
            }

            document.getElementById('balanceSummary').classList.add('hidden');
            document.getElementById('transactionsSection').classList.add('hidden');
        }

        // Select a request
        async function selectRequest(budgetCode, eventType, requestId) {
            // Highlight selected
            document.querySelectorAll('.request-item').forEach(el => {
                const isSelected = el.onclick.toString().includes(requestId);
                el.classList.toggle('border-blue-500', isSelected);
                el.classList.toggle('bg-blue-50', isSelected);
            });

            const summaryContainer = document.getElementById('balanceSummary');
            const transSection = document.getElementById('transactionsSection');
            const transTable = document.getElementById('transactionsTable');

            summaryContainer.classList.remove('hidden');
            summaryContainer.innerHTML = '<div class="text-gray-400 text-center">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';

            try {
                const res = await fetch('/portal/test2/transactions/' + encodeURIComponent(budgetCode) + '/' + encodeURIComponent(eventType) + '/' + encodeURIComponent(requestId));
                const data = await res.json();

                const balanceClass = data.is_balanced ? 'balance-ok' : 'balance-error';
                const balanceIcon = data.is_balanced ? 'âœ… ØªØ±Ø§Ø²' : 'âŒ Ø¹Ø¯Ù… ØªØ±Ø§Ø²';

                summaryContainer.className = `mt-4 p-4 rounded-xl border-2 ${balanceClass}`;
                summaryContainer.innerHTML = `
                    <div class="text-center font-bold text-lg mb-2">${balanceIcon}</div>
                    <div class="grid grid-cols-3 gap-2 text-sm text-center">
                        <div>
                            <div class="text-gray-600">Ø¨Ø¯Ù‡Ú©Ø§Ø±</div>
                            <div class="font-bold">${formatNumber(data.total_debit)}</div>
                        </div>
                        <div>
                            <div class="text-gray-600">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±</div>
                            <div class="font-bold">${formatNumber(data.total_credit)}</div>
                        </div>
                        <div>
                            <div class="text-gray-600">Ø§Ø®ØªÙ„Ø§Ù</div>
                            <div class="font-bold">${formatNumber(data.balance)}</div>
                        </div>
                    </div>
                `;

                // Show transactions table
                transSection.classList.remove('hidden');
                window.currentTransactions = data.transactions;
                let tableHtml = '';
                data.transactions.forEach((t, i) => {
                    tableHtml += `
                        <tr class="border-b hover:bg-blue-50 cursor-pointer transition-colors" onclick="showTransactionDetail(${i})">
                            <td class="p-3">${i + 1}</td>
                            <td class="p-3 font-mono">${t.doc_no}</td>
                            <td class="p-3">${t.tit_j_name || '-'}</td>
                            <td class="p-3">${t.rad_j_name || '-'}</td>
                            <td class="p-3 font-mono">${t.opr_code || '-'}</td>
                            <td class="p-3 text-left font-mono text-green-700">${t.debit ? formatNumber(t.debit) : '-'}</td>
                            <td class="p-3 text-left font-mono text-red-700">${t.credit ? formatNumber(t.credit) : '-'}</td>
                        </tr>
                    `;
                });
                transTable.innerHTML = tableHtml;
            } catch (e) {
                summaryContainer.innerHTML = '<div class="text-red-500 text-center">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</div>';
            }
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('trusteeFilter').value = '';
            document.getElementById('subjectFilter').value = '';
            document.getElementById('rowTypeFilter').value = '';
        }

        // Handle Enter key in search
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchBudgets();
        });

        // Show transaction detail
        function showTransactionDetail(index) {
            const t = window.currentTransactions[index];
            if (!t) return;

            const container = document.getElementById('transactionDetailContent');
            const box = document.getElementById('transactionDetailBox');

            container.innerHTML = `
                <!-- Document Info -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="text-sm text-gray-500 mb-2 font-bold">ğŸ“„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³Ù†Ø¯</div>
                    <div class="space-y-1 text-sm">
                        <div><span class="text-gray-500">Ø´Ù…Ø§Ø±Ù‡ Ø³Ù†Ø¯:</span> <span class="font-mono font-bold text-blue-600">${t.doc_no}</span></div>
                        <div><span class="text-gray-500">Ø³Ø§Ù„ Ù…Ø§Ù„ÛŒ:</span> ${t.fin_year || '-'}</div>
                        <div><span class="text-gray-500">Ú©Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:</span> <span class="font-mono">${t.request_id || '-'}</span></div>
                        <div><span class="text-gray-500">Ú©Ø¯ Ø¨ÙˆØ¯Ø¬Ù‡:</span> <span class="font-mono">${t.budget_no || '-'}</span></div>
                    </div>
                </div>

                <!-- Area Info -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="text-sm text-gray-500 mb-2 font-bold">ğŸ¢ Ù…Ù†Ø·Ù‚Ù‡</div>
                    <div class="space-y-1 text-sm">
                        <div><span class="text-gray-500">Ú©Ø¯ Ù…Ù†Ø·Ù‚Ù‡:</span> ${t.area_no || '-'}</div>
                        <div><span class="text-gray-500">Ù†Ø§Ù… Ù…Ù†Ø·Ù‚Ù‡:</span> ${t.area_name || '-'}</div>
                    </div>
                </div>

                <!-- Event Info -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="text-sm text-gray-500 mb-2 font-bold">ğŸ“Œ Ø±ÙˆÛŒØ¯Ø§Ø¯ Ù…Ø§Ù„ÛŒ</div>
                    <div class="space-y-1 text-sm">
                        <div><span class="text-gray-500">Ù†ÙˆØ¹:</span> ${t.event_type || '-'}</div>
                        <div><span class="text-gray-500">Ú©Ø¯ Ø¹Ù…Ù„ÛŒØ§Øª:</span> <span class="font-mono">${t.opr_code || '-'}</span></div>
                    </div>
                </div>

                <!-- Title Hierarchy -->
                <div class="bg-white p-4 rounded-xl shadow-sm col-span-1 md:col-span-2 lg:col-span-3">
                    <div class="text-sm text-gray-500 mb-2 font-bold">ğŸ“Š Ø³Ø±ÙØµÙ„â€ŒÙ‡Ø§ (Ú©Ù„ â†’ Ø¬Ø²Ø¡)</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-400">Ø³Ø±ÙØµÙ„ Ú©Ù„</div>
                            <div class="font-mono text-xs">${t.tit_k_no || '-'}</div>
                            <div class="text-xs text-gray-600">${t.tit_k_name || '-'}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-400">Ø³Ø±ÙØµÙ„ Ù…Ø¹ÛŒÙ†</div>
                            <div class="font-mono text-xs">${t.tit_m_no || '-'}</div>
                            <div class="text-xs text-gray-600">${t.tit_m_name || '-'}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-400">Ø³Ø±ÙØµÙ„ ØªÙØµÛŒÙ„ÛŒ</div>
                            <div class="font-mono text-xs">${t.tit_t_no || '-'}</div>
                            <div class="text-xs text-gray-600">${t.tit_t_name || '-'}</div>
                        </div>
                        <div class="bg-blue-50 p-2 rounded border border-blue-200">
                            <div class="text-xs text-blue-500">Ø³Ø±ÙØµÙ„ Ø¬Ø²Ø¡</div>
                            <div class="font-mono text-xs font-bold">${t.tit_j_no || '-'}</div>
                            <div class="text-xs text-gray-600">${t.tit_j_name || '-'}</div>
                        </div>
                    </div>
                </div>

                <!-- Rad Hierarchy -->
                <div class="bg-white p-4 rounded-xl shadow-sm col-span-1 md:col-span-2 lg:col-span-3">
                    <div class="text-sm text-gray-500 mb-2 font-bold">ğŸ“‹ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ (Ú©Ù„ â†’ Ø¬Ø²Ø¡)</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-400">Ø±Ø¯ÛŒÙ Ú©Ù„</div>
                            <div class="font-mono text-xs">${t.rad_k_no || '-'}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-400">Ø±Ø¯ÛŒÙ Ù…Ø¹ÛŒÙ†</div>
                            <div class="font-mono text-xs">${t.rad_m_no || '-'}</div>
                        </div>
                        <div class="bg-gray-50 p-2 rounded">
                            <div class="text-xs text-gray-400">Ø±Ø¯ÛŒÙ ØªÙØµÛŒÙ„ÛŒ</div>
                            <div class="font-mono text-xs">${t.rad_t_no || '-'}</div>
                        </div>
                        <div class="bg-purple-50 p-2 rounded border border-purple-200">
                            <div class="text-xs text-purple-500">Ø±Ø¯ÛŒÙ Ø¬Ø²Ø¡</div>
                            <div class="font-mono text-xs font-bold">${t.rad_j_no || '-'}</div>
                            <div class="text-xs text-gray-600">${t.rad_j_name || '-'}</div>
                        </div>
                    </div>
                </div>

                <!-- Amounts -->
                <div class="bg-white p-4 rounded-xl shadow-sm col-span-1 md:col-span-2 lg:col-span-3">
                    <div class="text-sm text-gray-500 mb-2 font-bold">ğŸ’° Ù…Ø¨Ø§Ù„Øº</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <div class="text-sm text-green-600">Ø¨Ø¯Ù‡Ú©Ø§Ø±</div>
                            <div class="font-mono text-lg font-bold text-green-700">${t.debit ? formatNumber(t.debit) : '0'}</div>
                        </div>
                        <div class="bg-red-50 p-3 rounded-lg text-center">
                            <div class="text-sm text-red-600">Ø¨Ø³ØªØ§Ù†Ú©Ø§Ø±</div>
                            <div class="font-mono text-lg font-bold text-red-700">${t.credit ? formatNumber(t.credit) : '0'}</div>
                        </div>
                    </div>
                </div>
            `;

            box.classList.remove('hidden');
            box.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Close transaction detail
        function closeTransactionDetail() {
            document.getElementById('transactionDetailBox').classList.add('hidden');
        }

        // Initialize
        loadFilters();
    </script>
</body>

</html>